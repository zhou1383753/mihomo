
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="robots" content="noindex, nofollow">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta http-equiv="cache-control" content="no-siteapp">
    <title>会员后台</title>
    <meta name="author" content="StarYu">
    <link rel="stylesheet" href="./static/layui/css/layui.css"  media="all">
    <script src="./static/layui/layui.js" charset="utf-8"></script>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin" id="toggleSidebar">


    <!-- 左侧导航 -->


    <script>
        //JavaScript代码区域
        layui.use('element', function(){
            var element = layui.element;

        });
    </script>

    <script>
        layui.use('layer', function(){ //独立版的layer无需执行这一句
            var $ = layui.jquery, layer = layui.layer; //独立版的layer无需执行这一句


            $('#toggle-btn').click(function() {
                if ($('#toggleSidebar').hasClass('toggleSidebar')) {
                    $('#toggleSidebar').removeClass('toggleSidebar');
                } else {
                    $('#toggleSidebar').addClass('toggleSidebar');
                }
            });

            $('#logout').click(function () {
                $.ajax({
                    url:"/index/index/logout.html",
                    success:function (data) {
                        layer.msg('退出成功',{
                            icon:6,
                            time:1000
                        },function () {
                            //jump
                            location.href=data.url;
                        });
                    }
                })
            });

            $('#zxczz').click(function () {
                layer.open({
                    type: 2,
                    area: setpage(),
                    content: "/index/user/zxcz.html" //这里content是一个URL，如果你不想让iframe出现滚动条，你还可以content: ['http://sentsin.com', 'no']
                });
            });

            function setpage() {
                var wid=window.innerWidth;
                if(wid>600){
                    return ['30%','70%'];
                }else{
                    return ['80%','90%'];
                }
            }
        });
    </script>

    <!-- 内容主体 -->

        <!-- 主内容 -->


        <table id="vpnTable" lay-filter="vpnTableFilter"></table>
        <script type="text/html" id="toolbarDemo">
            <div class="layui-btn-container">
                <button class="layui-btn layui-btn-sm" lay-event="getCheckData">选中编辑</button>
                <button class="layui-btn layui-btn-sm" lay-event="getCheckLength">检测代理</button>
                <!-- <button class="layui-btn layui-btn-sm" lay-event="ycjc">延迟检测</button>-->
                <button class="layui-btn layui-btn-sm" lay-event="genxing">复制数据</button>
                <button class="layui-btn layui-btn-sm" lay-event="hhmr">恢复出厂配置</button>
                <button class="layui-btn layui-btn-sm" lay-event="updata">日志</button>
            </div>
        </script>
        <!-- 注意：如果你直接复制所有代码到本地，上述 JS 路径需要改成你本地的 -->

</div>


<script>
    layui.use('layer', function(){ //独立版的layer无需执行这一句
        var $ = layui.jquery,
            layer = layui.layer; //独立版的layer无需执行这一句

        $('#tixian').click(function () {
            layer.open({
                type: 2,
                area: ['300px', '300px'],
                content: '/index/user/txhtml'
            });

        });

        $('#zhuanyue').click(function () {
            layer.open({
                type: 2,
                area: ['300px', '300px'],
                content: '/index/user/zhuanyue'
            });
        });


        $('#zxczzz').click(function () {
            layer.open({
                type: 2,
                area: ['360px', '500px'],
                skin: 'layui-layer-rim', //加上边框
                content: "/index/user/zxcz.html" //这里content是一个URL，如果你不想让iframe出现滚动条，你还可以content: ['http://sentsin.com', 'no']
            });
        });


        $("#reg").click(function(){
            window.location.href="reg";
        });

        $("#regst").click(function(){
            window.location.href="regst";
        });

    });
</script>
<script>
    layui.use('layer', function(){ //独立版的layer无需执行这一句
        var $ = layui.jquery,
            layer = layui.layer; //独立版的layer无需执行这一句

        $('#tixian').click(function () {
            layer.open({
                type: 2,
                area: ['300px', '300px'],
                content: '/index/user/txhtml'
            });

        });

        $('#zhuanyue').click(function () {
            layer.open({
                type: 2,
                area: ['300px', '300px'],
                content: '/index/user/zhuanyue'
            });
        });


        $('#zxczzz').click(function () {
            layer.open({
                type: 2,
                area: ['360px', '500px'],
                skin: 'layui-layer-rim', //加上边框
                content: "/index/user/zxcz.html" //这里content是一个URL，如果你不想让iframe出现滚动条，你还可以content: ['http://sentsin.com', 'no']
            });
        });


        $("#reg").click(function(){
            window.location.href="reg";
        });

        $("#regst").click(function(){
            window.location.href="regst";
        });

    });
</script>
<script>
    layui.use('table', function(){
        var table = layui.table;

        layui.use(['table', 'jquery'], function(){
            var table = layui.table;
            var $ = layui.jquery;

            // 初始化表格，但不设置 url，因为数据将通过 WebSocket 接收
            table.render({
                elem: '#vpnTable'
                ,toolbar: '#toolbarDemo' //开启头部工具栏，并为其绑定左侧模板
                ,defaultToolbar: ['filter', 'exports', 'print', { //自定义头部工具栏右侧图标。如无需自定义，去除该参数即可
                title: '提示'
                ,layEvent: 'LAYTABLE_TIPS'
                ,icon: 'layui-icon-tips'
            }]

                ,cols: [[
                    {type: 'checkbox', fixed: 'left'},
                    {field:'name', title:'ID', width:100, fixed: 'left', unresize: true, sort: true},
                    {field:'type', title:'类型', width:100},
                    {field:'connect-to', title:'服务器', width:300},
                    {field:'user', title:'用户名', width:100},
                    {field:'password', title:'密码', width:100},
                    {field:'running', title:'链接状态', width:100},
                    {field:'disabled', title:'接口禁用', width:100}
                ]],
                page: false, // 关闭分页
                limit: 1000,
            });
            // 建立 WebSocket 连接
            var socket = new WebSocket("ws://127.0.0.1:8080/ws");
            socket.onmessage = function(event) {
                var data = JSON.parse(event.data);
                // 使用 WebSocket 接收到的数据更新表格
                table.reload('vpnTable', {
                    data: data
                });
            };

        });


        //头工具栏事件
        table.on('toolbar(test)', function(obj){

            var checkStatus = table.checkStatus(obj.config.id);
            var $ = layui.jquery;
            var table1 = layui.table;
            switch(obj.event){
                case 'getCheckData':
                    //获取数据
                    var data = JSON.stringify(checkStatus.data);
                    var sl = checkStatus.data;
                    layer.open({


                        //formType: 2,//这里依然指定类型是多行文本框，但是在下面content中也可绑定多行文本框在这里插入代码片
                        title: '批量修改代理',
                        area: ['1024px', '650px'],
                        btnAlign: 'c',
                        closeBtn:'1',//右上角的关闭
                        content: `
    <div>
        <input type="radio" name="type" value="socks5" title="socks5" checked="">socks5
        <input type="radio" name="type" value="http" title="http">http
        <br>批量修改:${sl.length}个代理<br>
        代理格式为1.1.1.1|1080|user|pass|2022-11-11 一行一个
        <br>
        <textarea name="txt_remark" id="remark" style="width:950px;height:400px;"></textarea>

    </div>
`,


                        btn:['确认','取消','关闭'],
                        btn1: function (index, layero) {


                            var textValue = $('#remark').val(); // 获取多行文本框的值
                            var lines = textValue.split('\n'); // 按换行符分割文本
                            var jsonValue = JSON.stringify(lines); // 将数组转换为 JSON 格式的字符串
                            var radioButtonValue = $('input[name="type"]:checked').val();

                            var ydaili = checkStatus.data;
                            var xdaili = lines;

                            var newdata = [];

                            for (var i = 0; i < ydaili.length; i++) {
                                var ydailiItem = ydaili[i];
                                var serverInfo = xdaili[i].split('|');
                                var combined = ydailiItem.Name + "|" + serverInfo[0] + "|" + serverInfo[1] + "|" + serverInfo[2] + "|" + serverInfo[3];
                                newdata.push(combined);
                            }

                            var jsonOutput = JSON.stringify(newdata);



                            $.ajax({
                                url:"update",
                                type:'post',
                                data:{
                                    xdaili:jsonOutput,
                                    sl:sl.length,
                                    type:radioButtonValue
                                },
                                datatype:'json',


                                success:function (data) {

                                    if(data.code===0){

                                        layer.msg('操作完成，即将跳转到代理列表页...', {
                                            time: 2000, // 设定2秒后关闭提示框
                                            shade: [0.8, '#fff'], // 设定遮罩层样式
                                            shadeClose: true, // 点击遮罩层时关闭提示框
                                            end: function() {
                                                // 延迟2秒后执行跳转
                                                setTimeout(function() {
                                                    location.href = '/';
                                                }, 10);
                                            }
                                        });

                                    }else{

                                        alert(data+'！');

                                    }
                                }
                            })

                            return false;
                        },
                        btn2:function(index){
                            //alert('您刚才点击了取消按钮');
                            layer.close(index);
                            return false;//点击按钮按钮不想让弹层关闭就返回false
                        },
                        btn3:function(index){
                            //alert('您刚才点击了关闭按钮');
                            layer.close(index);
                            return false;//点击按钮按钮不想让弹层关闭就返回false
                        }

                    });
                    break;
                case 'getCheckLength':
                    var sl = checkStatus.data;
                    var data = JSON.stringify(checkStatus.data);
                    $.ajax({
                        url:"check",
                        type:'post',
                        data:{
                            ydaili:data
                        },
                        datatype:'json',
                        //弹出一个等待层
                        beforeSend: function () {
                            //正在加载
                            index= layer.load(0,{shade:false});
                        },
                        success:function (data) {
                            //关闭加载等待层
                            layer.close(index);

                            if(data=='ok'){

                                layer.msg('操作完成，即将跳转到代理列表页...', {
                                    time: 2000, // 设定2秒后关闭提示框
                                    shade: [0.8, '#fff'], // 设定遮罩层样式
                                    shadeClose: true, // 点击遮罩层时关闭提示框
                                    end: function() {
                                        // 延迟2秒后执行跳转
                                        setTimeout(function() {
                                            location.href = 'dllist.html';
                                        }, 10);
                                    }
                                });

                            }else{
                                layer.open({
                                    //formType: 2,//这里依然指定类型是多行文本框，但是在下面content中也可绑定多行文本框在这里插入代码片
                                    title: '批量检测代理',
                                    area: ['1024px', '590px'],
                                    btnAlign: 'c',
                                    closeBtn:'1',//右上角的关闭
                                    content: '<textarea name="txt_remark" id="remark" style="width:1000px;height:450px;">'+data+'</textarea>',
                                    btn:['确认','取消','关闭'],
                                    btn1: function (index, layero) {
                                        var value1 = $('#remark').val();//获取多行文本框的值
                                        var radioButtonValue = $('input[name="type"]:checked').val();

                                        return false;
                                    },
                                    btn2:function(index){
                                        //alert('您刚才点击了取消按钮');
                                        layer.close(index);
                                        return false;//点击按钮按钮不想让弹层关闭就返回false
                                    },
                                    btn3:function(index){
                                        //alert('您刚才点击了关闭按钮');
                                        layer.close(index);
                                        return false;//点击按钮按钮不想让弹层关闭就返回false
                                    }

                                });

                            }
                        }
                    })



                    break;
                case 'genxing':
                    //取json数据
                    //获取数据
                    var objArr = checkStatus.data; // 对象数组
                    var aa='';
                    for (var i = 0; i < objArr.length; i++) { // 使用对象数组进行遍历
                        var obj = objArr[i];
                        aa=aa+obj['Server']+'|'+obj['Port']+'|'+obj['Username']+'|'+obj['Password']+'\n';
                    }

                    const textarea = document.createElement('textarea');
                    textarea.value = aa;
                    document.body.appendChild(textarea);

                    textarea.select();
                    if (document.execCommand('copy')) {
                        document.execCommand('copy');

                    }
                    document.body.removeChild(textarea);

                    layer.msg('复制成功')

                    break;

                case 'isAll':
                    layer.msg(checkStatus.isAll ? '全选': '未全选');
                    break;

                case 'ycjc':
                    layer.open({
                        type: 2,
                        skin: 'layui-layer-demo', //样式类名
                        title: '标题',
                        anim: 2,
                        area: ['360px', '560px'],
                        shadeClose: true, //开启遮罩关闭
                        content: 'http://10.0.0.1:9999/ui/#/proxies'
                    });
                    break;

                case 'hhmr':
                    // 弹出确认窗口
                    layer.confirm('恢复出厂将覆盖现有IP，请备份好当前IP', {
                        title: '出厂配置恢复',
                        btn: ['确定', '取消'] // 按钮
                    }, function(index) {
                        // 点击确定后的回调函数
                        layer.open({
                            type: 2,
                            skin: 'layui-layer-demo', // 样式类名
                            title: '标题',
                            anim: 2,
                            area: ['360px', '360px'],
                            shadeClose: true, // 开启遮罩关闭
                            content: '/yaml'
                        });

                        // 关闭当前弹出层
                        var parentIndex = parent.layer.getFrameIndex(window.name); // 获取当前窗口的索引
                        parent.layer.close(parentIndex); // 关闭索引为parentIndex的层

                        // 关闭确认窗口
                        layer.close(index); // 关闭索引为index的确认窗口

                    }, function() {
                        // 点击取消后的回调函数（可选）
                        // 这里可以添加取消操作的代码
                    });
                    break;



//日志
                case 'updata':
                    layer.open({
                        type: 2,
                        skin: 'layui-layer-demo', //样式类名
                        title: '运行日志',
                        anim: 2,
                        area: ['900px', '550px'],
                        shadeClose: true, //开启遮罩关闭
                        content: 'http://10.0.0.1/webfig/#WebFig',
                        loading: false // 禁用加载动画
                    });
                    break;



            };

        });





        //监听行工具事件
        table.on('tool(test)', function(obj){
            var data = obj.data;
            //console.log(obj)
            if(obj.event === 'del'){
                layer.confirm('真的删除行么', function(index){
                    obj.del();
                    layer.close(index);
                });
            } else if(obj.event === 'edit'){
                layer.prompt({
                    formType: 2
                    ,value: data.email
                }, function(value, index){

                    obj.update({
                        email: value
                    });

                    layer.close(index);
                });
            }
        });
    });


</script>

</body>
</html>